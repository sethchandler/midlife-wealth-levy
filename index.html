<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Midlife Wealth Levy – Interactive Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- ml-matrix for optimized numerical methods -->
  <script src="https://cdn.jsdelivr.net/npm/ml-matrix@6.10.4/lib/index.min.js"></script>
  <!-- KaTeX for equations -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
          onload="renderMathInElement(document.body);"
          integrity=""
          crossorigin="anonymous"></script>
  <!-- Local stylesheets and scripts -->
  <link rel="stylesheet" href="styles.css">
  <script defer src="economic-model.js"></script>
  <script defer src="chart-manager.js"></script>
  <script defer src="ui-controller.js"></script>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <h1>Midlife Wealth Levy — Model Controls</h1>
      <div class="chips">
        <span class="pill">Deterministic • CRRA</span>
        <span class="pill">Client-only</span>
        <span class="pill">Interior optimum (with constraint check)</span>
      </div>
      <h2>Time & Rates</h2>
      <div class="row">
        <label>Real return \(r\)</label>
        <input id="r" type="number" step="0.01" value="0.03">
        <input id="r_slider" type="range" min="-0.02" max="0.12" step="0.01" value="0.03">
      </div>
      <div class="row">
        <label>Pure impatience \(\rho\)</label>
        <input id="rho" type="number" step="0.01" value="0.01">
        <input id="rho_slider" type="range" min="0" max="0.10" step="0.01" value="0.01">
      </div>
      <div class="row">
        <label>Levy time \(T_1\)</label>
        <input id="T1" type="number" step="1" value="10">
        <input id="T1_slider" type="range" min="1" max="40" step="1" value="10">
      </div>
      <div class="row">
        <label>Horizon after \(T_1\) (\(T_2\))</label>
        <input id="T2" type="number" step="1" value="20">
        <input id="T2_slider" type="range" min="1" max="40" step="1" value="20">
      </div>

      <h2>Preferences</h2>
      <div class="row">
        <label>CRRA (consumption) \(\gamma\)</label>
        <input id="gamma" type="number" step="0.1" value="2.0">
        <input id="gamma_slider" type="range" min="0.1" max="3.0" step="0.1" value="2.0">
      </div>
      <div class="row">
        <label>CRRA (bequest) \(\eta\)</label>
        <input id="eta" type="number" step="0.1" value="1.5">
        <input id="eta_slider" type="range" min="0.1" max="3.0" step="0.1" value="1.5">
      </div>
      <div class="row">
        <label>Bequest weight \(\beta\)</label>
        <input id="beta" type="number" step="0.1" value="0.5">
        <input id="beta_slider" type="range" min="0.01" max="20" step="0.01" value="0.5">
      </div>

      <h2>Initial Conditions & Flows</h2>
      <div class="row">
        <label>Initial wealth \(w_0 = 1\) (fixed)</label>
        <input id="w0" type="hidden" value="1">
        <span class="pill">w₀ = 1.000</span>
      </div>
      <div class="row">
        <label>Income flow \(y\)</label>
        <input id="y" type="number" step="0.01" value="0">
        <input id="y_slider" type="range" min="0" max="1" step="0.01" value="0">
      </div>
      <div class="row">
        <label>Borrowing floor \(\zeta\)</label>
        <input id="zeta" type="number" step="0.1" value="0">
        <input id="zeta_slider" type="range" min="0" max="5" step="0.1" value="0">
      </div>

      <h2>Levy</h2>
      <div class="row">
        <label>Levy rate \(\tau\)</label>
        <input id="tau" type="number" step="0.01" value="0.1">
        <input id="tau_slider" type="range" min="0" max="0.9" step="0.01" value="0.1">
      </div>

      <div class="footer">
        <div id="status" class="small"></div>
        <div id="warnings" class="small warn" style="margin-top:6px;"></div>
        <div id="errors" class="small err" style="margin-top:6px;"></div>
      </div>
    </aside>

    <main class="panel">
      <div class="chart-section">
        <div class="chart-header">
          <h3>Consumption Trajectory</h3>
          <div class="y-axis-controls">
            <label>Y-axis:</label>
            <select id="cons-y-mode" class="y-mode-select">
              <option value="auto">Auto</option>
              <option value="sticky25">Sticky 25%</option>
              <option value="sticky50">Sticky 50%</option>
              <option value="baseline">Baseline</option>
            </select>
            <button id="cons-reset" class="reset-btn" title="Reset to auto scaling">Reset</button>
            <span id="cons-range" class="value-display"></span>
          </div>
        </div>
        <canvas id="consChart" height="320"></canvas>
      </div>
      
      <div class="chart-section">
        <div class="chart-header">
          <h3>Wealth Trajectory</h3>
          <div class="y-axis-controls">
            <label>Y-axis:</label>
            <select id="wealth-y-mode" class="y-mode-select">
              <option value="auto">Auto</option>
              <option value="sticky25">Sticky 25%</option>
              <option value="sticky50">Sticky 50%</option>
              <option value="baseline">Baseline</option>
            </select>
            <button id="wealth-reset" class="reset-btn" title="Reset to auto scaling">Reset</button>
            <span id="wealth-range" class="value-display"></span>
          </div>
        </div>
        <canvas id="wealthChart" width="800" height="400" style="width: 100%; max-height: 400px;"></canvas>
      </div>
      
      <div class="chart-section">
        <div class="chart-header">
          <h3>τ-Comparatives</h3>
          <div class="y-axis-controls">
            <label>Y-axis:</label>
            <select id="tau-y-mode" class="y-mode-select">
              <option value="auto">Auto</option>
              <option value="sticky25">Sticky 25%</option>
              <option value="sticky50">Sticky 50%</option>
              <option value="baseline">Baseline</option>
            </select>
            <button id="tau-reset" class="reset-btn" title="Reset to auto scaling">Reset</button>
            <span id="tau-range" class="value-display"></span>
          </div>
        </div>
        <canvas id="tauChart" width="800" height="400" style="width: 100%; max-height: 400px;"></canvas>
      </div>
      
      <div class="chart-section">
        <h3>Mathematical Equations</h3>
        <div class="eqbox">
          <div>Effective discount force: \(\kappa=\dfrac{\rho+(\gamma-1)r}{\gamma},\quad g=\dfrac{r-\rho}{\gamma},\quad R=e^{r(T_1+T_2)},\quad P(H)=\dfrac{1-e^{-\kappa H}}{\kappa}.\)</div>
          <div id="eq_derived" class="small"></div>
        </div>
        <div class="eqbox">
          <div>Terminal equation (with income):</div>
          <div>\(W_T + (K_1(\tau)+K_2)\,W_T^{\alpha} = R(1-\tau)\Big(w_0+\frac{y}{r}\Big)+e^{rT_2}\tau\frac{y}{r}-\frac{y}{r},\quad \alpha=\eta/\gamma.\)</div>
          <div id="eq_terminal_nums" class="small"></div>
        </div>
        <div class="eqbox">
          <div>\(K_1(\tau)=\beta^{-1/\gamma} e^{\frac{\gamma-1}{\gamma}r(T_1+T_2)}(1-\tau)^{\frac{\gamma-1}{\gamma}} P(T_1),\quad
               K_2=\beta^{-1/\gamma} e^{\frac{\gamma-1}{\gamma}rT_2-\frac{\rho}{\gamma}T_1} P(T_2).\)</div>
          <div id="eq_K_nums" class="small"></div>
        </div>
        <div class="eqbox">
          <div>Levels: \(B=\big(\beta^{-1} e^{-\rho T_1} e^{-rT_2} W_T^\eta\big)^{1/\gamma},\quad
                        A=\beta^{-1/\gamma} e^{-r(T_1+T_2)/\gamma}(1-\tau)^{-1/\gamma} W_T^{\eta/\gamma}.\)</div>
          <div id="eq_levels_nums" class="small"></div>
        </div>
        <div class="eqbox">
          <div>Wealth (interior): pre-levy \(X(t)=e^{rt}\big(X_0 - A P(t)\big)\), post-levy \(X(t)=e^{r(t-T_1)}\big(X_1^+ - B P(t-T_1)\big)\), with \(X=W+y/r,\, X_0=w_0+y/r,\, X_1^+=(1-\tau)X_1^-+\tau y/r\).</div>
          <div id="eq_we_nums" class="small"></div>
        </div>
      </div>
    </main>
  </div>

</body>
</html>
